!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
!
!    This file is part of ICTP RegCM.
!
!    ICTP RegCM is free software: you can redistribute it and/or modify
!    it under the terms of the GNU General Public License as published by
!    the Free Software Foundation, either version 3 of the License, or
!    (at your option) any later version.
!
!    ICTP RegCM is distributed in the hope that it will be useful,
!    but WITHOUT ANY WARRANTY; without even the implied warranty of
!    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
!    GNU General Public License for more details.
!
!    You should have received a copy of the GNU General Public License
!    along with ICTP RegCM.  If not, see <http://www.gnu.org/licenses/>.
!
!::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

module mod_sun
!
! Sun zenith and declination
!
   use mod_intkinds
   use mod_realkinds
   use mod_constants
   use mod_dynparam
   use mod_runparams
   use mod_atm_interface
   use mod_mpmessage
   use mod_mppparam
   use mod_service
   use mod_date
   use mod_sunorbit

   implicit none

   private

   real(rk8) , dimension(3,1610:2008) :: tsi
   real(rk8) , parameter :: tsifac = 0.9965D0
   integer(ik4) :: ii , jj

   public :: zenitm
   !
   ! ANNUAL MEAN TSI
   ! Lean (GRL 2000) with Wang Lean Sheeley (ApJ 2005) background
   ! Mon Apr  6 11:29:27 2009
   ! PMOD absolute scale , multiply by 0.9965 for TIM scale
   ! YEAR, TSI 11-yr cycle, TSI cycle+background
   !
   data ((tsi(ii,jj),ii=1,3),jj=1610,2008) / &
       1610.5D0,1365.8477D0,1365.5469D0, 1611.5D0,1365.8342D0,1365.5300D0, &
       1612.5D0,1366.2461D0,1365.9279D0, 1613.5D0,1366.3650D0,1366.0399D0, &
       1614.5D0,1366.4451D0,1366.1143D0, 1615.5D0,1366.1591D0,1365.8314D0, &
       1616.5D0,1365.7358D0,1365.4148D0, 1617.5D0,1365.6107D0,1365.2889D0, &
       1618.5D0,1365.6038D0,1365.2783D0, 1619.5D0,1365.7001D0,1365.3684D0, &
       1620.5D0,1365.7001D0,1365.3645D0, 1621.5D0,1365.7001D0,1365.3607D0, &
       1622.5D0,1365.7001D0,1365.3568D0, 1623.5D0,1365.7001D0,1365.3530D0, &
       1624.5D0,1365.6621D0,1365.3121D0, 1625.5D0,1365.8926D0,1365.5303D0, &
       1626.5D0,1365.7816D0,1365.4191D0, 1627.5D0,1365.7106D0,1365.3418D0, &
       1628.5D0,1365.7577D0,1365.3518D0, 1629.5D0,1365.7261D0,1365.2922D0, &
       1630.5D0,1365.5946D0,1365.1428D0, 1631.5D0,1365.6255D0,1365.1515D0, &
       1632.5D0,1365.5946D0,1365.1183D0, 1633.5D0,1365.6951D0,1365.2158D0, &
       1634.5D0,1365.6157D0,1365.1362D0, 1635.5D0,1365.6249D0,1365.1411D0, &
       1636.5D0,1365.5946D0,1365.1080D0, 1637.5D0,1365.5946D0,1365.1046D0, &
       1638.5D0,1366.0768D0,1365.5710D0, 1639.5D0,1366.1344D0,1365.6241D0, &
       1640.5D0,1365.7001D0,1365.1936D0, 1641.5D0,1365.5946D0,1365.0815D0, &
       1642.5D0,1365.9277D0,1365.4006D0, 1643.5D0,1365.7183D0,1365.1824D0, &
       1644.5D0,1365.6761D0,1365.1272D0, 1645.5D0,1365.5946D0,1365.0454D0, &
       1646.5D0,1365.5946D0,1365.0449D0, 1647.5D0,1365.5946D0,1365.0443D0, &
       1648.5D0,1365.5946D0,1365.0424D0, 1649.5D0,1365.5946D0,1365.0399D0, &
       1650.5D0,1365.5946D0,1365.0389D0, 1651.5D0,1365.5946D0,1365.0383D0, &
       1652.5D0,1365.6227D0,1365.0657D0, 1653.5D0,1365.6010D0,1365.0439D0, &
       1654.5D0,1365.5995D0,1365.0358D0, 1655.5D0,1365.5981D0,1365.0260D0, &
       1656.5D0,1365.5989D0,1365.0249D0, 1657.5D0,1365.5961D0,1365.0199D0, &
       1658.5D0,1365.5946D0,1365.0145D0, 1659.5D0,1365.5946D0,1365.0125D0, &
       1660.5D0,1365.6086D0,1365.0259D0, 1661.5D0,1365.6002D0,1365.0178D0, &
       1662.5D0,1365.5946D0,1365.0125D0, 1663.5D0,1365.5946D0,1365.0125D0, &
       1664.5D0,1365.5946D0,1365.0126D0, 1665.5D0,1365.5946D0,1365.0127D0, &
       1666.5D0,1365.5946D0,1365.0127D0, 1667.5D0,1365.5946D0,1365.0125D0, &
       1668.5D0,1365.5946D0,1365.0122D0, 1669.5D0,1365.5946D0,1365.0122D0, &
       1670.5D0,1365.5946D0,1365.0122D0, 1671.5D0,1365.6010D0,1365.0183D0, &
       1672.5D0,1365.5974D0,1365.0148D0, 1673.5D0,1365.5946D0,1365.0122D0, &
       1674.5D0,1365.5961D0,1365.0135D0, 1675.5D0,1365.5946D0,1365.0120D0, &
       1676.5D0,1365.6073D0,1365.0239D0, 1677.5D0,1365.5967D0,1365.0134D0, &
       1678.5D0,1365.5961D0,1365.0128D0, 1679.5D0,1365.5946D0,1365.0115D0, &
       1680.5D0,1365.6002D0,1365.0170D0, 1681.5D0,1365.5946D0,1365.0115D0, &
       1682.5D0,1365.5946D0,1365.0115D0, 1683.5D0,1365.5946D0,1365.0115D0, &
       1684.5D0,1365.6045D0,1365.0211D0, 1685.5D0,1365.5946D0,1365.0117D0, &
       1686.5D0,1365.5989D0,1365.0159D0, 1687.5D0,1365.5953D0,1365.0126D0, &
       1688.5D0,1365.5981D0,1365.0159D0, 1689.5D0,1365.5961D0,1365.0146D0, &
       1690.5D0,1365.5946D0,1365.0143D0, 1691.5D0,1365.5946D0,1365.0157D0, &
       1692.5D0,1365.5946D0,1365.0172D0, 1693.5D0,1365.5946D0,1365.0177D0, &
       1694.5D0,1365.5946D0,1365.0179D0, 1695.5D0,1365.5953D0,1365.0186D0, &
       1696.5D0,1365.5946D0,1365.0178D0, 1697.5D0,1365.5946D0,1365.0178D0, &
       1698.5D0,1365.5946D0,1365.0179D0, 1699.5D0,1365.5946D0,1365.0184D0, &
       1700.5D0,1365.5974D0,1365.0216D0, 1701.5D0,1365.5981D0,1365.0236D0, &
       1702.5D0,1365.5989D0,1365.0266D0, 1703.5D0,1365.6135D0,1365.0444D0, &
       1704.5D0,1365.6234D0,1365.0594D0, 1705.5D0,1365.6333D0,1365.0752D0, &
       1706.5D0,1365.6171D0,1365.0637D0, 1707.5D0,1365.6318D0,1365.0802D0, &
       1708.5D0,1365.6143D0,1365.0658D0, 1709.5D0,1365.6058D0,1365.0614D0, &
       1710.5D0,1365.5974D0,1365.0634D0, 1711.5D0,1365.5946D0,1365.0739D0, &
       1712.5D0,1365.5946D0,1365.0798D0, 1713.5D0,1365.5967D0,1365.0863D0, &
       1714.5D0,1365.6010D0,1365.1023D0, 1715.5D0,1365.6199D0,1365.1294D0, &
       1716.5D0,1365.6586D0,1365.1694D0, 1717.5D0,1365.7177D0,1365.2294D0, &
       1718.5D0,1365.6578D0,1365.1707D0, 1719.5D0,1365.8329D0,1365.3429D0, &
       1720.5D0,1365.7590D0,1365.2859D0, 1721.5D0,1365.7450D0,1365.2880D0, &
       1722.5D0,1365.6719D0,1365.2209D0, 1723.5D0,1365.6255D0,1365.1837D0, &
       1724.5D0,1365.7042D0,1365.2681D0, 1725.5D0,1365.6846D0,1365.2574D0, &
       1726.5D0,1365.8490D0,1365.4274D0, 1727.5D0,1365.8512D0,1365.4327D0, &
       1728.5D0,1366.0459D0,1365.6237D0, 1729.5D0,1365.7633D0,1365.3479D0, &
       1730.5D0,1366.0845D0,1365.6605D0, 1731.5D0,1365.5946D0,1365.1812D0, &
       1732.5D0,1365.7211D0,1365.3090D0, 1733.5D0,1365.5946D0,1365.1984D0, &
       1734.5D0,1365.5946D0,1365.2086D0, 1735.5D0,1365.7233D0,1365.3386D0, &
       1736.5D0,1365.9362D0,1365.5486D0, 1737.5D0,1365.7633D0,1365.3827D0, &
       1738.5D0,1365.7141D0,1365.3370D0, 1739.5D0,1365.9636D0,1365.5795D0, &
       1740.5D0,1365.6599D0,1365.2811D0, 1741.5D0,1366.0001D0,1365.6107D0, &
       1742.5D0,1365.7078D0,1365.3247D0, 1743.5D0,1365.6530D0,1365.2698D0, &
       1744.5D0,1365.5946D0,1365.2137D0, 1745.5D0,1365.5946D0,1365.2164D0, &
       1746.5D0,1365.5946D0,1365.2223D0, 1747.5D0,1365.5946D0,1365.2305D0, &
       1748.5D0,1366.0233D0,1365.6548D0, 1749.5D0,1366.0388D0,1365.6749D0, &
       1750.5D0,1366.0023D0,1365.6385D0, 1751.5D0,1365.8314D0,1365.4680D0, &
       1752.5D0,1365.7985D0,1365.4402D0, 1753.5D0,1365.7626D0,1365.4220D0, &
       1754.5D0,1365.6565D0,1365.3351D0, 1755.5D0,1365.6277D0,1365.3220D0, &
       1756.5D0,1365.6459D0,1365.3501D0, 1757.5D0,1365.7689D0,1365.4734D0, &
       1758.5D0,1365.8806D0,1365.5867D0, 1759.5D0,1365.9425D0,1365.6501D0, &
       1760.5D0,1365.9144D0,1365.6254D0, 1761.5D0,1366.0760D0,1365.7898D0, &
       1762.5D0,1365.9193D0,1365.6514D0, 1763.5D0,1365.8350D0,1365.5811D0, &
       1764.5D0,1365.8090D0,1365.5573D0, 1765.5D0,1365.6537D0,1365.4065D0, &
       1766.5D0,1365.6206D0,1365.3759D0, 1767.5D0,1365.8329D0,1365.5817D0, &
       1768.5D0,1366.0957D0,1365.8346D0, 1769.5D0,1366.2869D0,1366.0194D0, &
       1770.5D0,1366.2806D0,1366.0220D0, 1771.5D0,1366.1527D0,1365.9155D0, &
       1772.5D0,1366.0599D0,1365.8433D0, 1773.5D0,1365.8224D0,1365.6243D0, &
       1774.5D0,1365.7760D0,1365.5862D0, 1775.5D0,1365.6339D0,1365.4493D0, &
       1776.5D0,1365.6937D0,1365.5039D0, 1777.5D0,1365.8638D0,1365.6656D0, &
       1778.5D0,1366.1007D0,1365.8955D0, 1779.5D0,1366.1625D0,1365.9534D0, &
       1780.5D0,1365.9812D0,1365.7753D0, 1781.5D0,1366.0944D0,1365.8868D0, &
       1782.5D0,1365.8258D0,1365.6217D0, 1783.5D0,1365.7429D0,1365.5284D0, &
       1784.5D0,1365.6283D0,1365.3966D0, 1785.5D0,1365.7070D0,1365.4558D0, &
       1786.5D0,1366.0396D0,1365.7682D0, 1787.5D0,1366.2216D0,1365.9337D0, &
       1788.5D0,1366.1744D0,1365.8801D0, 1789.5D0,1366.1548D0,1365.8595D0, &
       1790.5D0,1366.0521D0,1365.7604D0, 1791.5D0,1365.8982D0,1365.6101D0, &
       1792.5D0,1365.8898D0,1365.5961D0, 1793.5D0,1365.8828D0,1365.5756D0, &
       1794.5D0,1365.8069D0,1365.4816D0, 1795.5D0,1365.7050D0,1365.3645D0, &
       1796.5D0,1365.6909D0,1365.3348D0, 1797.5D0,1365.6487D0,1365.2817D0, &
       1798.5D0,1365.6277D0,1365.2567D0, 1799.5D0,1365.6339D0,1365.2629D0, &
       1800.5D0,1365.6719D0,1365.3035D0, 1801.5D0,1365.9537D0,1365.5757D0, &
       1802.5D0,1365.8428D0,1365.4541D0, 1803.5D0,1365.7246D0,1365.3218D0, &
       1804.5D0,1365.7465D0,1365.3257D0, 1805.5D0,1365.7745D0,1365.3361D0, &
       1806.5D0,1365.6881D0,1365.2385D0, 1807.5D0,1365.6298D0,1365.1710D0, &
       1808.5D0,1365.6193D0,1365.1458D0, 1809.5D0,1365.6030D0,1365.1180D0, &
       1810.5D0,1365.5946D0,1365.1094D0, 1811.5D0,1365.5967D0,1365.1222D0, &
       1812.5D0,1365.6227D0,1365.1631D0, 1813.5D0,1365.6586D0,1365.2117D0, &
       1814.5D0,1365.6677D0,1365.2355D0, 1815.5D0,1365.7126D0,1365.2906D0, &
       1816.5D0,1365.8110D0,1365.3866D0, 1817.5D0,1365.7914D0,1365.3600D0, &
       1818.5D0,1365.7471D0,1365.3119D0, 1819.5D0,1365.7295D0,1365.2968D0, &
       1820.5D0,1365.6698D0,1365.2410D0, 1821.5D0,1365.6249D0,1365.2194D0, &
       1822.5D0,1365.6157D0,1365.2432D0, 1823.5D0,1365.6030D0,1365.2483D0, &
       1824.5D0,1365.6305D0,1365.2893D0, 1825.5D0,1365.6958D0,1365.3627D0, &
       1826.5D0,1365.7957D0,1365.4659D0, 1827.5D0,1365.9066D0,1365.5771D0, &
       1828.5D0,1365.9952D0,1365.6646D0, 1829.5D0,1366.0107D0,1365.6825D0, &
       1830.5D0,1366.0465D0,1365.7235D0, 1831.5D0,1365.8701D0,1365.5585D0, &
       1832.5D0,1365.7542D0,1365.4565D0, 1833.5D0,1365.6403D0,1365.3612D0, &
       1834.5D0,1365.6635D0,1365.3966D0, 1835.5D0,1365.9200D0,1365.6577D0, &
       1836.5D0,1366.2988D0,1366.0393D0, 1837.5D0,1366.3635D0,1366.1127D0, &
       1838.5D0,1366.1387D0,1365.8997D0, 1839.5D0,1366.0521D0,1365.8174D0, &
       1840.5D0,1365.9341D0,1365.7007D0, 1841.5D0,1365.7816D0,1365.5490D0, &
       1842.5D0,1365.7267D0,1365.4940D0, 1843.5D0,1365.6522D0,1365.4237D0, &
       1844.5D0,1365.6775D0,1365.4543D0, 1845.5D0,1365.8041D0,1365.5820D0, &
       1846.5D0,1365.9025D0,1365.6803D0, 1847.5D0,1366.0023D0,1365.7816D0, &
       1848.5D0,1366.1976D0,1365.9781D0, 1849.5D0,1366.1829D0,1365.9691D0, &
       1850.5D0,1365.9812D0,1365.7698D0, 1851.5D0,1366.0029D0,1365.7744D0, &
       1852.5D0,1365.9446D0,1365.6947D0, 1853.5D0,1365.8448D0,1365.5848D0, &
       1854.5D0,1365.7162D0,1365.4614D0, 1855.5D0,1365.6262D0,1365.3828D0, &
       1856.5D0,1365.6163D0,1365.3853D0, 1857.5D0,1365.7169D0,1365.4946D0, &
       1858.5D0,1365.9066D0,1365.6875D0, 1859.5D0,1366.1260D0,1365.9054D0, &
       1860.5D0,1366.1963D0,1365.9718D0, 1861.5D0,1366.0916D0,1365.8623D0, &
       1862.5D0,1365.9496D0,1365.7120D0, 1863.5D0,1365.8821D0,1365.6283D0, &
       1864.5D0,1365.8370D0,1365.5660D0, 1865.5D0,1365.7534D0,1365.4755D0, &
       1866.5D0,1365.6909D0,1365.4119D0, 1867.5D0,1365.6382D0,1365.3597D0, &
       1868.5D0,1365.7977D0,1365.5194D0, 1869.5D0,1366.0325D0,1365.7557D0, &
       1870.5D0,1366.2708D0,1365.9944D0, 1871.5D0,1366.2054D0,1365.9343D0, &
       1872.5D0,1366.1576D0,1365.8876D0, 1873.5D0,1365.9580D0,1365.6866D0, &
       1874.5D0,1365.8406D0,1365.5582D0, 1875.5D0,1365.7035D0,1365.4095D0, &
       1876.5D0,1365.6586D0,1365.3593D0, 1877.5D0,1365.6543D0,1365.3596D0, &
       1878.5D0,1365.6135D0,1365.3309D0, 1879.5D0,1365.6255D0,1365.3533D0, &
       1880.5D0,1365.7689D0,1365.5000D0, 1881.5D0,1365.9124D0,1365.6443D0, &
       1882.5D0,1365.9313D0,1365.6676D0, 1883.5D0,1365.9791D0,1365.7147D0, &
       1884.5D0,1365.8812D0,1365.6166D0, 1885.5D0,1365.7909D0,1365.5070D0, &
       1886.5D0,1365.6487D0,1365.3417D0, 1887.5D0,1365.6234D0,1365.2982D0, &
       1888.5D0,1365.5962D0,1365.2628D0, 1889.5D0,1365.5652D0,1365.2344D0, &
       1890.5D0,1365.5912D0,1365.2690D0, 1891.5D0,1365.8303D0,1365.5204D0, &
       1892.5D0,1365.9163D0,1365.6190D0, 1893.5D0,1366.0458D0,1365.7600D0, &
       1894.5D0,1366.1332D0,1365.8553D0, 1895.5D0,1366.0166D0,1365.7390D0, &
       1896.5D0,1365.8434D0,1365.5581D0, 1897.5D0,1365.7094D0,1365.4126D0, &
       1898.5D0,1365.6982D0,1365.3899D0, 1899.5D0,1365.6534D0,1365.3381D0, &
       1900.5D0,1365.6216D0,1365.3074D0, 1901.5D0,1365.5294D0,1365.2292D0, &
       1902.5D0,1365.5165D0,1365.2378D0, 1903.5D0,1365.7083D0,1365.4479D0, &
       1904.5D0,1365.9651D0,1365.7180D0, 1905.5D0,1365.7684D0,1365.5291D0, &
       1906.5D0,1365.9651D0,1365.7255D0, 1907.5D0,1365.8604D0,1365.6097D0, &
       1908.5D0,1365.9426D0,1365.6748D0, 1909.5D0,1365.8459D0,1365.5642D0, &
       1910.5D0,1365.7173D0,1365.4309D0, 1911.5D0,1365.6285D0,1365.3473D0, &
       1912.5D0,1365.5706D0,1365.3010D0, 1913.5D0,1365.5739D0,1365.3175D0, &
       1914.5D0,1365.6302D0,1365.3844D0, 1915.5D0,1365.9285D0,1365.6890D0, &
       1916.5D0,1366.1349D0,1365.8990D0, 1917.5D0,1366.2821D0,1366.0480D0, &
       1918.5D0,1366.2454D0,1366.0096D0, 1919.5D0,1366.0179D0,1365.7802D0, &
       1920.5D0,1365.8523D0,1365.6178D0, 1921.5D0,1365.7351D0,1365.5127D0, &
       1922.5D0,1365.6019D0,1365.3948D0, 1923.5D0,1365.6211D0,1365.4265D0, &
       1924.5D0,1365.6436D0,1365.4581D0, 1925.5D0,1365.8406D0,1365.6622D0, &
       1926.5D0,1365.9348D0,1365.7633D0, 1927.5D0,1366.1135D0,1365.9468D0, &
       1928.5D0,1365.9885D0,1365.8245D0, 1929.5D0,1365.9429D0,1365.7833D0, &
       1930.5D0,1365.9159D0,1365.7655D0, 1931.5D0,1365.7780D0,1365.6436D0, &
       1932.5D0,1365.6583D0,1365.5364D0, 1933.5D0,1365.5300D0,1365.4156D0, &
       1934.5D0,1365.6361D0,1365.5275D0, 1935.5D0,1365.8500D0,1365.7439D0, &
       1936.5D0,1366.2373D0,1366.1333D0, 1937.5D0,1366.1718D0,1366.0676D0, &
       1938.5D0,1366.1079D0,1366.0031D0, 1939.5D0,1366.0894D0,1365.9868D0, &
       1940.5D0,1366.0143D0,1365.9242D0, 1941.5D0,1365.9130D0,1365.8451D0, &
       1942.5D0,1365.7847D0,1365.7419D0, 1943.5D0,1365.6052D0,1365.5841D0, &
       1944.5D0,1365.6224D0,1365.6140D0, 1945.5D0,1365.8850D0,1365.8810D0, &
       1946.5D0,1365.9818D0,1365.9791D0, 1947.5D0,1366.2190D0,1366.2185D0, &
       1948.5D0,1366.3475D0,1366.3490D0, 1949.5D0,1366.2528D0,1366.2555D0, &
       1950.5D0,1366.0098D0,1366.0131D0, 1951.5D0,1365.7721D0,1365.7765D0, &
       1952.5D0,1365.7653D0,1365.7676D0, 1953.5D0,1365.6313D0,1365.6284D0, &
       1954.5D0,1365.6599D0,1365.6564D0, 1955.5D0,1365.7793D0,1365.7773D0, &
       1956.5D0,1366.3097D0,1366.3109D0, 1957.5D0,1366.6632D0,1366.6681D0, &
       1958.5D0,1366.6246D0,1366.6328D0, 1959.5D0,1366.3717D0,1366.3828D0, &
       1960.5D0,1366.2682D0,1366.2767D0, 1961.5D0,1365.9230D0,1365.9199D0, &
       1962.5D0,1365.7656D0,1365.7484D0, 1963.5D0,1365.7152D0,1365.6963D0, &
       1964.5D0,1365.7114D0,1365.6976D0, 1965.5D0,1365.7378D0,1365.7341D0, &
       1966.5D0,1365.9058D0,1365.9178D0, 1967.5D0,1366.0889D0,1366.1143D0, &
       1968.5D0,1366.1295D0,1366.1644D0, 1969.5D0,1366.2069D0,1366.2476D0, &
       1970.5D0,1366.2036D0,1366.2426D0, 1971.5D0,1365.9354D0,1365.9580D0, &
       1972.5D0,1366.0519D0,1366.0525D0, 1973.5D0,1365.8131D0,1365.7991D0, &
       1974.5D0,1365.7448D0,1365.7271D0, 1975.5D0,1365.5466D0,1365.5345D0, &
       1976.5D0,1365.6458D0,1365.6453D0, 1977.5D0,1365.8248D0,1365.8331D0, &
       1978.5D0,1366.2616D0,1366.2747D0, 1979.5D0,1366.6193D0,1366.6348D0, &
       1980.5D0,1366.6323D0,1366.6482D0, 1981.5D0,1366.6829D0,1366.6951D0, &
       1982.5D0,1366.2808D0,1366.2859D0, 1983.5D0,1366.1989D0,1366.1992D0, &
       1984.5D0,1365.8088D0,1365.8103D0, 1985.5D0,1365.6382D0,1365.6416D0, &
       1986.5D0,1365.6345D0,1365.6379D0, 1987.5D0,1365.7865D0,1365.7899D0, &
       1988.5D0,1366.0792D0,1366.0826D0, 1989.5D0,1366.6445D0,1366.6479D0, &
       1990.5D0,1366.5499D0,1366.5533D0, 1991.5D0,1366.4423D0,1366.4457D0, &
       1992.5D0,1366.2987D0,1366.3021D0, 1993.5D0,1366.0251D0,1366.0286D0, &
       1994.5D0,1365.7937D0,1365.7971D0, 1995.5D0,1365.6962D0,1365.6996D0, &
       1996.5D0,1365.6086D0,1365.6121D0, 1997.5D0,1365.7365D0,1365.7399D0, &
       1998.5D0,1366.0986D0,1366.1021D0, 1999.5D0,1366.3817D0,1366.3851D0, &
       2000.5D0,1366.6836D0,1366.6836D0, 2001.5D0,1366.6022D0,1366.6022D0, &
       2002.5D0,1366.6807D0,1366.6807D0, 2003.5D0,1366.2300D0,1366.2300D0, &
       2004.5D0,1366.0480D0,1366.0480D0, 2005.5D0,1365.8545D0,1365.8545D0, &
       2006.5D0,1365.8107D0,1365.8107D0, 2007.5D0,1365.7240D0,1365.7240D0, &
       2008.5D0,1365.6918D0,1365.6918 /

  contains
  !
  ! This subroutine computes the solar declination angle
  ! from the julian date.
  !
  subroutine solar1
    implicit none
    real(rk8) :: decdeg , obliq , mvelp
    integer :: iyear , imonth , iday , ihour
#ifdef DEBUG
    character(len=dbgslen) :: subroutine_name = 'solar1'
    integer(ik4) , save :: idindx = 0
    call time_begin(subroutine_name,idindx)
#endif
    calday = yeardayfrac(idatex)
    call split_idate(idatex,iyear,imonth,iday,ihour)
    call orb_params(iyear,eccen,obliq,mvelp,obliqr,lambm0,mvelpp)
    call orb_decl(calday,eccen,mvelpp,lambm0,obliqr,declin,eccf)
    decdeg = declin/degrad
    if ( myid == italk .and. mod(ktau,kday) == 0 ) then
      write (stdout,'(a,f12.5,a,f12.8,a)') ' JDay ', calday , &
        ' solar declination angle = ', decdeg , ' degrees'
      write(stdout, '(18x,a,f12.4,a)') ' solar TSI irradiance    = ' , &
        solcon, ' W/m^2'
    end if
#ifdef DEBUG
    call time_end(subroutine_name,idindx)
#endif
  end subroutine solar1
  !
  ! This subroutine calculates the cosine of the solar zenith angle
  ! for all longitude points of the RegCM domain. It needs as inputs
  ! the longitude and latitude of the points, the initial date of the
  ! simulation and the gmt. All these quantities are specified
  ! in the initialization procedure of RegCM
  !
  subroutine zenitm(coszrs)
    implicit none
    real(rk8) , pointer , intent (inout), dimension(:,:) :: coszrs
    integer(ik4) :: i , j
    real(rk8) :: xxlat , xxlon
#ifdef DEBUG
    character(len=dbgslen) :: subroutine_name = 'zenitm'
    integer(ik4) , save :: idindx = 0
    call time_begin(subroutine_name,idindx)
#endif
    !
    ! Update solar constant for today
    !
    if ( mod(ktau,kday) == 0 ) then
      solcon = solar_irradiance( )
      scon = solcon*d_1000
    end if
    call solar1
    do i = ici1 , ici2
      do j = jci1 , jci2
        xxlat = mddom%xlat(j,i)*degrad
        xxlon = mddom%xlon(j,i)*degrad
        coszrs(j,i) = orb_cosz(calday,xxlat,xxlon,declin)
        coszrs(j,i) = dmax1(0.0D0,coszrs(j,i))
        coszrs(j,i) = dmin1(1.0D0,coszrs(j,i))
      end do
    end do
#ifdef DEBUG
    call time_end(subroutine_name,idindx)
#endif
  end subroutine zenitm

  real(rk8) function solar_irradiance( )
    implicit none
    integer(ik4) :: iyear , iidate
    real(rk8) :: w1 , w2
#ifdef DEBUG
    character(len=dbgslen) :: subroutine_name = 'solar_irradiance'
    integer(ik4) , save :: idindx = 0
    call time_begin(subroutine_name,idindx)
#endif
    if ( isolconst == 1 ) then
      solar_irradiance = 1367.0D0
    else
      calday = yeardayfrac(idatex)
      if ( calday > dayspy/2.0D0 ) then
        w2 = calday/dayspy-0.5D0
        w1 = 1.0D0-w2
        iyear = xyear
      else
        w1 = 0.5D0-calday/dayspy
        w2 = 1.0D0-w1
        iyear = xyear-1
      end if
      if ( xyear < 1610 ) then
        call fatal(__FILE__,__LINE__,'TSI OUT OF RANGE.')
      end if
      iidate = xyear*10000+xmonth*100+xday
      if ( iidate > 20080630 ) then
        iyear = mod(xyear,12)+1996
      end if
      solar_irradiance = tsifac*(w1*tsi(3,iyear)+w2*tsi(3,iyear+1))
    end if
    if ( itweak == 1 ) then
      if ( itweak_solar_irradiance == 1 ) then
        solar_irradiance = solar_irradiance + solar_tweak
      end if
    end if
#ifdef DEBUG
    call time_end(subroutine_name,idindx)
#endif
  end function solar_irradiance

end module mod_sun
! vim: tabstop=8 expandtab shiftwidth=2 softtabstop=2
